<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>دليل مشاية الأربعين</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f9f9f9;
      padding: 20px;
      direction: rtl;
      line-height: 1.6;
      margin: 0;
      transition: background 0.3s, color 0.3s;
      color: #333; /* Default text color */
    }
    body.dark-mode {
      background: #1a1a1a; /* Darker background */
      color: #e0e0e0;
    }
    h1 {
      color: #800000;
      font-size: 32px; /* Slightly larger */
      margin-bottom: 25px;
      text-align: center;
      font-weight: 700;
    }
    #language-switcher {
      text-align: center;
      margin-bottom: 15px;
    }
    #language-switcher button, #dark-mode-toggle {
      margin: 0 8px; /* More spacing */
      padding: 8px 16px; /* Larger buttons */
      font-size: 15px;
      font-weight: bold;
      background: #fff;
      border: 1px solid #800000;
      color: #800000;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s, color 0.3s, border-color 0.3s, transform 0.1s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* Soft shadow */
    }
    #language-switcher button:hover, #dark-mode-toggle:hover {
        background: #800000;
        color: #fff;
        transform: translateY(-1px);
    }
    body.dark-mode #language-switcher button, body.dark-mode #dark-mode-toggle {
        background: #333;
        border-color: #bb4444;
        color: #ff8888;
    }
    body.dark-mode #language-switcher button:hover, body.dark-mode #dark-mode-toggle:hover {
        background: #bb4444;
        color: #fff;
    }

    input[type="text"] {
      padding: 14px; /* Larger padding */
      font-size: 18px;
      font-weight: 600;
      margin: 0 auto 15px auto; /* More margin */
      width: 90vw;
      max-width: 900px;
      display: block;
      border: 2px solid #800000;
      border-radius: 10px; /* More rounded */
      box-sizing: border-box;
      background-color: #fff;
      color: #000;
      transition: background-color 0.3s, color 0.3s, border-color 0.3s, box-shadow 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); /* Stronger shadow */
    }
    input[type="text"]:focus {
        outline: none;
        border-color: #b30000; /* Darker red on focus */
        box-shadow: 0 0 0 3px rgba(128, 0, 0, 0.2); /* Focus ring */
    }
    body.dark-mode input[type="text"] {
      background-color: #2a2a2a; /* Darker input background */
      color: #eee;
      border-color: #ff6666;
      box-shadow: 0 2px 8px rgba(255, 100, 100, 0.2);
    }
    body.dark-mode input[type="text"]:focus {
        border-color: #ff9999;
        box-shadow: 0 0 0 3px rgba(255, 100, 100, 0.3);
    }

    #suggestions {
      max-width: 600px;
      margin: 0 auto 15px auto; /* More margin */
      text-align: center;
      font-size: 15px;
      color: #800000;
      font-weight: 600;
    }
    #suggestions a {
      color: #800000;
      text-decoration: none; /* No underline */
      font-weight: 700;
      transition: color 0.3s;
    }
    #suggestions a:hover {
        color: #b30000; /* Darker red on hover */
        text-decoration: underline; /* Underline on hover */
    }
    body.dark-mode #suggestions {
        color: #ff8888;
    }
    body.dark-mode #suggestions a {
        color: #ff6666;
    }
    body.dark-mode #suggestions a:hover {
        color: #ff9999;
    }

    #countdown-container {
      max-width: 600px;
      margin: 15px auto 35px auto; /* More margin */
      padding: 20px; /* More padding */
      background: #fff;
      border-radius: 10px; /* More rounded */
      border: 1px solid #800000;
      text-align: center;
      transition: background 0.3s, color 0.3s, border-color 0.3s, box-shadow 0.3s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); /* Stronger shadow */
    }
    body.dark-mode #countdown-container {
      background: #2a2a2a;
      border-color: #bb4444;
      color: #eee;
      box-shadow: 0 4px 12px rgba(255, 100, 100, 0.25);
    }
    #countdown-title {
      font-size: 24px; /* Slightly larger */
      font-weight: 700;
      margin-bottom: 12px;
      color: #800000;
      transition: color 0.3s;
    }
    body.dark-mode #countdown-title {
      color: #ff6666;
    }
    #countdown {
      font-size: 32px; /* Larger font */
      font-weight: 700;
      color: #000;
      letter-spacing: 2px;
      transition: color 0.3s;
    }
    body.dark-mode #countdown {
      color: #eee;
    }

    /* --- NEW COLLAPSIBLE INFO SECTION STYLES --- */
    #info-section {
      max-width: 600px;
      margin: 20px auto 40px auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      overflow: hidden; /* For rounded corners on first/last item */
      border: 1px solid #ddd; /* Light border for the whole section */
    }
    body.dark-mode #info-section {
      background: #2a2a2a;
      box-shadow: 0 4px 12px rgba(255, 100, 100, 0.25);
      border-color: #555;
    }

    .info-item {
      border-bottom: 1px solid #eee; /* Separator for each item */
    }
    .info-item:last-child {
      border-bottom: none; /* No border for the last item */
    }
    body.dark-mode .info-item {
      border-color: #3d3d3d;
    }

    .info-header {
      padding: 15px 20px;
      background-color: #f0f0f0; /* Light background for header */
      color: #800000;
      font-weight: 700;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s, color 0.2s;
    }
    .info-header:hover {
      background-color: #e0e0e0;
    }
    body.dark-mode .info-header {
      background-color: #333;
      color: #ff6666;
    }
    body.dark-mode .info-header:hover {
      background-color: #444;
    }

    .info-header .arrow {
      font-size: 20px;
      transition: transform 0.3s ease;
      margin-left: 10px; /* Space between text and arrow */
    }
    .info-header.expanded .arrow {
      transform: rotate(90deg); /* Rotate arrow when expanded */
    }

    .info-content {
      padding: 15px 20px;
      background-color: #fff;
      color: #333;
      font-size: 16px;
      line-height: 1.8;
      max-height: 0; /* Initially hidden */
      overflow: hidden;
      transition: max-height 0.4s ease-out, padding 0.4s ease-out;
    }
    body.dark-mode .info-content {
      background-color: #2a2a2a;
      color: #e0e0e0;
    }

    .info-content ul {
      list-style: none; /* Remove default list bullets */
      padding: 0;
      margin: 0;
    }
    .info-content ul li {
      margin-bottom: 8px;
      position: relative;
      padding-right: 20px; /* Space for custom bullet */
    }
    /* Custom bullet point for list items */
    .info-content ul li::before {
      content: '•'; /* Use a bullet character */
      color: #800000; /* Red bullet */
      font-weight: bold;
      position: absolute;
      right: 0;
      top: 0;
    }
    body.dark-mode .info-content ul li::before {
      color: #ff6666;
    }
    .info-content p {
        margin-top: 0;
        margin-bottom: 10px;
    }
    .info-content p:last-child {
        margin-bottom: 0;
    }
    .info-content strong {
        color: #550000; /* Darker red for bold text */
    }
    body.dark-mode .info-content strong {
        color: #ff8888;
    }
    /* --- END NEW COLLAPSIBLE INFO SECTION STYLES --- */

    #columns-container {
      max-width: 600px;
      margin: 0 auto 50px auto; /* More bottom margin */
    }

    /* --- COLUMN DESIGN STYLES (MATCHING IMAGE) --- */
    .column {
      display: flex; /* To arrange header and content side by side */
      background: #f9f9f9; /* Light background */
      margin-bottom: 15px;
      border-radius: 10px; /* Rounded corners */
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden; /* To contain the floated header */
      transition: background 0.3s, color 0.3s, box-shadow 0.3s;
      padding: 0; /* Remove padding from the main container */
      scroll-margin-top: 20px; /* Keep for scrolling to column */
    }
    body.dark-mode .column {
      background: #2a2a2a;
      box-shadow: 0 2px 8px rgba(255, 100, 100, 0.2);
    }

    .column-header {
      background-color: #800000; /* Dark red background */
      color: #fff;
      padding: 15px 20px;
      text-align: center;
      min-width: 80px; /* Adjust as needed to fit the number */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      flex-shrink: 0; /* Prevent it from shrinking */
    }

    .column-header strong {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 5px;
      color: #fff; /* Ensure text is white */
      display: block; /* Ensure it takes full width */
      text-align: center; /* Center the "العمود" text */
    }

    .column-header span {
      font-size: 28px; /* Larger font for column number */
      font-weight: bold;
      color: #fff; /* Ensure number is white */
      line-height: 1; /* Adjust line height for the number */
    }

    .column .name {
      font-size: 17px;
      color: #333;
      text-align: right; /* Align text to the right */
      padding: 15px 20px; /* Add padding to the content area */
      flex-grow: 1; /* Allow the name section to take remaining space */
      box-sizing: border-box; /* Include padding in width calculation */
      margin-bottom: 0; /* Remove default bottom margin */
      /* Note: If multiple names per column are desired, you might need a wrapper div for them */
    }
    .column .name .name-item { /* Style for individual names within the name container */
        margin-bottom: 5px; /* Spacing between names */
    }
    .column .name .name-item:last-child {
        margin-bottom: 0;
    }
    body.dark-mode .column .name {
      color: #eee;
    }
    /* --- END COLUMN DESIGN STYLES --- */

    #logo-container {
      position: fixed;
      bottom: 15px; /* Slightly higher */
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95); /* Less transparent */
      padding: 8px 15px; /* More padding */
      border-radius: 8px; /* More rounded */
      box-shadow: 0 0 8px rgba(0,0,0,0.25); /* Stronger shadow */
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px; /* More space */
      z-index: 9999;
      font-weight: bold;
      font-family: 'Cairo', sans-serif;
      font-size: 13px; /* Slightly larger */
      color: #800000;
      transition: background 0.3s, color 0.3s, box-shadow 0.3s;
    }
    body.dark-mode #logo-container {
      background: rgba(34, 34, 34, 0.95);
      color: #ff6666;
      box-shadow: 0 0 8px #ff4444;
    }
    #logo-container img {
      height: 45px; /* Slightly larger logo */
      width: auto;
      display: block;
      /* Add this filter for dark mode */
      transition: filter 0.3s ease-in-out; /* Smooth transition for the filter */
    }
    body.dark-mode #logo-container img {
      filter: invert(1) hue-rotate(180deg) brightness(1.2); /* Invert colors for dark mode */
      /* invert(1) turns black to white, hue-rotate(180deg) adjusts hues, brightness(1.2) makes it brighter */
    }
    #logo-container span {
      color: #000;
      font-size: 11px; /* Slightly larger */
      transition: color 0.3s;
    }
    body.dark-mode #logo-container span {
      color: #ff9999;
    }
    #offline-message {
        display: none;
        text-align: center;
        color: #d32f2f;
        font-weight: bold;
        margin-top: 20px;
        padding: 10px;
        background-color: #ffebee;
        border-radius: 5px;
        border: 1px solid #ef9a9a;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }
    body.dark-mode #offline-message {
        color: #ff9999;
        background-color: #4a1c1c;
        border-color: #8b0000;
    }

    /* New style for no results message */
    #no-results-message {
        text-align: center;
        margin-top: 20px;
        font-size: 18px;
        color: #d32f2f; /* Red color for warning */
        font-weight: bold;
        display: none; /* Hidden by default */
    }
    body.dark-mode #no-results-message {
        color: #ff8888;
    }
  </style>
</head>
<body>
  <div id="logo-container">
    <img src="logo.png" alt="شعار Khadem - خادم" />
    <span>@khademcrs</span>
  </div>

  <div id="language-switcher">
    <button onclick="switchLanguage('ar')" aria-label="تبديل إلى اللغة العربية">ع</button>
    <button onclick="switchLanguage('en')" aria-label="Switch to English">E</button>
    <button onclick="switchLanguage('fa')" aria-label="تغییر به زبان فارسی">ف</button>
    <button id="dark-mode-toggle" title="تبديل الوضع الداكن" aria-label="تبديل الوضع الداكن">🌗</button>
  </div>

  <h1>🏴 دليل مشاية الأربعين 🏴</h1>

  <input type="text" id="search" placeholder="ابحث برقم العمود، الاسم..." aria-label="مربع البحث عن الأعمدة والأسماء" />

  <p id="suggestions">
    للاقتراح أو التعديل،
    <a href="https://forms.gle/U6CPCJba3KsJKBHW9" target="_blank" rel="noopener noreferrer">اضغط هنا</a>
  </p>

  <div id="countdown-container">
    <div id="countdown-title">العد التنازلي ليوم الأربعين</div>
    <div id="countdown"></div>
  </div>

  <div id="offline-message">
    أنت غير متصل بالإنترنت. قد تكون البيانات قديمة.
  </div>

  <div id="info-section">
    <div class="info-item">
      <div class="info-header">
        <span>معلومات مهمة للمشاة</span>
        <span class="arrow">&#9658;</span> </div>
      <div class="info-content">
        <p><strong>⬅️ نقطة الانطلاق</strong></p>
        <ul>
          <li><strong>من العمود 1 إلى 182:</strong> هذه الأرقام مبدئية داخل النجف.</li>
          <li>تبدأ المسيرة من <strong>حرم الإمام علي عليه السلام</strong>، وتخرج من <strong>باب الساعة</strong> مشيًا باتجاه: <strong>شارع الإمام زين العابدين عليه السلام أو شارع الإمام الصادق عليه السلام</strong> ثم تستمر بشكل مستقيم حتى تصل إلى <strong>الشارع الرئيسي (طريق كربلاء)</strong> حيث تنضم إلى آلاف الزوار المتجهين إلى كربلاء.</li>
          <li>بعد قطع <strong>حوالي 75 كيلومترًا</strong>، تصل إلى العمود <strong>رقم 1452</strong>، وهو بجوار <strong>حرم مولانا أبي الفضل العباس عليه السلام</strong>.</li>
        </ul>

        <p><strong>✅ معلومات عامة</strong></p>
        <ul>
          <li>المسافة بين النجف وكربلاء: <strong>80 كيلومترًا</strong></li>
          <li>عدد الأعمدة: <strong>1452 عمودًا</strong></li>
          <li>المسافة بين كل عمودين: <strong>50 مترًا</strong></li>
          <li>(<strong>20 عمود = 1 كيلومتر</strong>)</li>
          <li>المدة التقريبية للمشي: <strong>من 2 إلى 3 أيام</strong></li>
          <li>أفضل وقت للانطلاق: <strong>16 أو 17 صفر</strong></li>
        </ul>

        <p><strong>🕘 جدول المشي المقترح</strong></p>
        <ul>
          <li>من <strong>بعد صلاة الفجر حتى 10 صباحًا</strong></li>
          <li>راحة حتى دخول صلاة الظهرين</li>
          <li>استئناف المسير من <strong>بعد صلاة العصر حتى 10 مساءً</strong></li>
          <li>راحة ونوم ليلاً</li>
        </ul>

        <p><strong>📌 تعليمات عامة للمشي</strong></p>
        <ul>
          <li>لا تُجهد نفسك، وخذ فترات راحة عند الحاجة.</li>
          <li>عند أذان المغرب، ابحث عن موكب للصلاة والعشاء والمبيت. لا تقلق من قلة المواكب، لكن لا تتأخر حتى لا تمتلئ.</li>
          <li>الليلة الأولى والثانية تُقضى في مواكب (حسينيات أو خيام) مع العشاء والنوم.</li>
          <li>مراكز المفقودين موجودة عند الأعمدة: <strong>٧٢ و ٣٣٥ و ٦٠٢ و ١١٠٣ و العتبتين المقدستين (الحسينية والعباسية)</strong> ويوجد مركز للتبليغ عن المفقودين <strong>كل 3 كيلومتر</strong>.</li>
        </ul>

        <p><strong>🎒 الأغراض والمستلزمات المقترحة</strong></p>
        <ul>
          <li><strong>خفّف الحمل:</strong> لا حاجة لحمل ماء أو طعام، فكل شيء متوفر مجانًا.</li>
          <li>خذ أدويتك الخاصة لما يكفي 2 أو 3 أيام. توجد عيادات متنقلة على الطريق.</li>
          <li>حقيبة صغيرة على الظهر أفضل من كيس باليد، ومعها شاحن متنقل.</li>
          <li>كريم للجلد مثل فازلين أو نيفيا لتجنب الطفح أو الاحتكاك. يُفضل استخدامه قبل بدء المشي.</li>
          <li>احمل في الجوال أو الورق: نعي، لطميات، زيارات، أدعية، قرآن</li>
          <li><strong>الحذاء:</strong> لا ترتدِ حذاءً جديدًا أو مغلقًا، الأفضل حذاء مفتوح مريح.</li>
          <li>جواز السفر والفيزا، واحتفظ بهما بعناية.</li>
          <li>عربة للأطفال في حال التعب وحمل مستلزماتهم.</li>
          <li>عصا تساعد كبار السن في المشي وتخفف التعب.</li>
        </ul>

        <p><strong>📍 ملاحظات مهمة</strong></p>
        <ul>
          <li>كل الخدمات (طعام، شراب، مبيت، تدليك) <strong>مجانية تمامًا</strong>. لا حاجة لحمل أموال كثيرة إلا إذا رغبت في التبرع للمواكب.</li>
          <li>دورات المياه متوفرة، وبعض المواكب توفر مراحيض إفرنجية.</li>
          <li>إذا تعبت، توجد <strong>مئات السيارات والباصات</strong> لنقلك إلى كربلاء بسهولة.</li>
          <li>اكتب <strong>اسمك وعنوان سكنك في كربلاء</strong> في ورقة، فقد تنقطع شبكة الجوال عند الوصول.</li>
          <li>إن احتجت الاتصال، فافعل ذلك <strong>قبل طلوع الشمس</strong> لتجنب الزحام في الشبكة.</li>
        </ul>

        <p><strong>🔰 توصيات</strong></p>
        <ul>
          <li>اجعل نيتك لله تعالى في المشي والخدمة الحسينية.</li>
          <li>حافظ على الصلاة في وقتها كما فعل الإمام الحسين عليه السلام يوم عاشوراء.</li>
          <li>اجعل أيام الأربعين أيام حزن وجد، وابتعد عن الضحك غير المناسب.</li>
          <li>أكثر من: <strong>اللهم صلِّ على محمد وآل محمد، وعجّل فرجهم، والعن أعداءهم، ووفقنا للاقتداء بهم يا كريم.</strong></li>
          <li>حافظ على نظافة وقداسة الأماكن المقدسة.</li>
          <li>أختي المؤمنة: اجعلي <strong>حجابك في هذه الأماكن الطاهرة</strong> أفضل وأستر من حجابك في بلدك.</li>
        </ul>
      </div>
    </div>
  </div>
  <div id="columns-container"></div>
  <p id="no-results-message" style="display:none;"></p> <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
  <script>
    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('Service Worker registered with scope:', registration.scope);
          })
          .catch(error => {
            console.error('Service Worker registration failed:', error);
          });
      });
    }

    const countdownDate = new Date('2025-08-15T00:00:00+03:00').getTime();
    let currentLang = localStorage.getItem('arbaeenGuideLang') || 'ar'; // Load last used language
    let columnsData = [];
    let fuse; // For fuzzy search

    const uiTexts = {
      ar: {
        heading: '🏴 دليل مشاية الأربعين 🏴',
        countdownTitle: 'العد التنازلي ليوم الأربعين',
        searchInput: 'ابحث برقم العمود، الاسم...',
        suggestions: `للاقتراح أو التعديل، <a href="https://forms.gle/U6CPCJba3KsJKBHW9" target="_blank" rel="noopener noreferrer">اضغط هنا</a>`,
        noResults: 'لا توجد نتائج.',
        offlineMessage: 'أنت غير متصل بالإنترنت. قد تكون البيانات قديمة.',
        columnText: 'العمود', // Added for column header
        dayUnit: 'يوم',
        infoSectionTitle: 'معلومات مهمة للمشاة' // New text for info section title
      },
      en: {
        heading: '🏴 Arbaeen Processions Guide 🏴',
        countdownTitle: 'Countdown to Arbaeen Day',
        searchInput: 'Search by column number, name...',
        suggestions: `To suggest edits or additions, <a href="https://forms.gle/U6CPCJba3KsJKBHW9" target="_blank" rel="noopener noreferrer">click here</a>`,
        noResults: 'No results found.',
        offlineMessage: 'You are offline. Data might be outdated.',
        columnText: 'Column', // Added for column header
        dayUnit: 'day',
        infoSectionTitle: 'Important Information for Walkers' // New text for info section title
      },
      fa: {
        heading: '🏴 راهنمای موکب‌های اربعین 🏴',
        countdownTitle: 'شمارش معکوس تا روز اربعین',
        searchInput: 'جستجو بر اساس شماره ستون، نام...',
        suggestions: `برای پیشنهاد یا ویرایش، <a href="https://forms.gle/U6CPCJba3KsJKBHW9" target="_blank" rel="noopener noreferrer">اینجا کلیک کنید</a>`,
        noResults: 'نتیجه‌ای یافت نشد.',
        offlineMessage: 'شما آفلاین هستید. ممکن است داده‌ها قدیمی باشند.',
        columnText: 'ستون', // Added for column header
        dayUnit: 'روز',
        infoSectionTitle: 'اطلاعات مهم برای زائرین' // New text for info section title
      }
    };

    function updateCountdown() {
      const now = new Date().getTime();
      const diff = countdownDate - now;
      const countdownContainer = document.getElementById('countdown-container');

      if (diff <= 0) {
        countdownContainer.style.display = 'none';
        return;
      } else {
        // Only show countdown if search input is empty
        if (document.getElementById('search').value.trim() === '') {
            countdownContainer.style.display = 'block';
        } else {
            countdownContainer.style.display = 'none';
        }
      }

      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);

      const dayText = uiTexts[currentLang].dayUnit + (currentLang === 'en' && days !== 1 ? 's' : '');

      document.getElementById('countdown').textContent =
        days + ' ' + dayText + ' ' + hours.toString().padStart(2, '0') + ':' +
        minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
    }

    function updateUIText(lang) {
      const texts = uiTexts[lang];
      document.querySelector('h1').textContent = texts.heading;
      document.getElementById('countdown-title').textContent = texts.countdownTitle;
      document.getElementById('search').placeholder = texts.searchInput;
      // Note: suggestions is handled dynamically in search event listener
      // document.getElementById('suggestions').innerHTML = texts.suggestions;
      document.getElementById('offline-message').textContent = texts.offlineMessage;
      // Update the info section title
      document.querySelector('#info-section .info-header span:first-child').textContent = texts.infoSectionTitle;
      // Update no results message
      document.getElementById('no-results-message').textContent = texts.noResults;
      // Re-render columns to update "العمود" text in headers if language changes
      renderColumns(columnsData); 
    }

    function switchLanguage(lang) {
      currentLang = lang;
      localStorage.setItem('arbaeenGuideLang', lang); // Save last used language
      document.documentElement.lang = lang;
      document.documentElement.dir = (lang === 'en') ? 'ltr' : 'rtl';
      updateUIText(lang);
      loadData();
    }

    async function loadData() {
      const container = document.getElementById('columns-container');
      const offlineMessage = document.getElementById('offline-message');
      offlineMessage.style.display = 'none'; // Hide by default

      try {
        const res = await fetch(`data-${currentLang}.json`);
        if (!res.ok) throw new Error('Failed to load data from network.');
        columnsData = await res.json();
        renderColumns(columnsData);
        // Cache data for offline use
        if ('caches' in window) {
            const cache = await caches.open('arbaeen-data-cache');
            await cache.put(new Request(`data-${currentLang}.json`), new Response(JSON.stringify(columnsData)));
        }
        initializeFuse(); // Initialize Fuse.js after data loads
      } catch (e) {
        console.error('Error loading data:', e);
        // Try to load from cache
        if ('caches' in window) {
            const cache = await caches.open('arbaeen-data-cache');
            const cachedResponse = await cache.match(new Request(`data-${currentLang}.json`));
            if (cachedResponse) {
                columnsData = await cachedResponse.json();
                renderColumns(columnsData);
                offlineMessage.style.display = 'block'; // Show offline message
                initializeFuse();
            } else {
                container.innerHTML = `<p style="text-align:center;color:red;">${uiTexts[currentLang].noResults}</p>`;
            }
        } else {
             container.innerHTML = `<p style="text-align:center;color:red;">${uiTexts[currentLang].noResults}</p>`;
        }
      }
    }

    function initializeFuse() {
        const options = {
            keys: [
                'column',
                'names'
            ],
            includeScore: true,
            threshold: 0.3, // Lower threshold for more strict matches, higher for looser
            ignoreLocation: true, // Search anywhere in the string
            findAllMatches: true,
            minMatchCharLength: 2,
        };
        fuse = new Fuse(columnsData, options);
    }

    function renderColumns(data) {
      const container = document.getElementById('columns-container');
      container.innerHTML = '';
      if (data.length === 0) {
        // This case is handled by the search event listener for specific no results message
        return; 
      }
      // Sort by column number before rendering
      data.sort((a, b) => a.column - b.column);
      data.forEach(col => {
        const colDiv = document.createElement('div');
        colDiv.className = 'column';
        colDiv.id = 'column-' + col.column;
        
        // --- UPDATED HTML STRUCTURE FOR EACH COLUMN ---
        // This will create a div for each name, allowing multiple names per column
        const namesHtml = col.names.map(name => `<div class="name-item">${name}</div>`).join('');
        colDiv.innerHTML = `
          <div class="column-header">
            <strong>${uiTexts[currentLang].columnText}</strong>
            <span>${col.column.toString().padStart(2, '0')}</span>
          </div>
          <div class="name">
            ${namesHtml}
          </div>
        `;
        // --- END UPDATED HTML STRUCTURE ---
        
        container.appendChild(colDiv);
      });
    }

    document.getElementById('search').addEventListener('input', e => {
      const q = e.target.value.trim();
      const countdownContainer = document.getElementById('countdown-container');
      const suggestionsElement = document.getElementById('suggestions'); // Renamed to avoid conflict
      const infoSection = document.getElementById('info-section');
      const noResultsMessage = document.getElementById('no-results-message');
      const columnsContainer = document.getElementById('columns-container');


      if (q === '') {
        // If search input is empty, show everything default
        countdownContainer.style.display = 'block';
        suggestionsElement.innerHTML = uiTexts[currentLang].suggestions; // Restore suggestions HTML
        suggestionsElement.style.display = 'block';
        infoSection.style.display = 'block';
        noResultsMessage.style.display = 'none'; // Hide no results message
        renderColumns(columnsData); // Render all columns
        return;
      }
      
      // If search input has text, hide default sections
      countdownContainer.style.display = 'none';
      infoSection.style.display = 'none';
      
      let filteredResults = [];
      if (fuse) {
          const searchResults = fuse.search(q);
          filteredResults = searchResults.map(result => result.item);
      } else {
          // Fallback if fuse.js isn't loaded for some reason (shouldn't happen)
          const isNumber = !isNaN(q) && q !== '';
          if (isNumber) {
              filteredResults = columnsData.filter(c => c.column.toString() === q);
          } else {
              filteredResults = columnsData.filter(c => 
                  c.names.some(name => name.toLowerCase().includes(q.toLowerCase())) || 
                  c.column.toString().includes(q)
              );
          }
      }
      
      renderColumns(filteredResults);

      if (filteredResults.length === 0) {
          noResultsMessage.textContent = uiTexts[currentLang].noResults;
          noResultsMessage.style.display = 'block'; // Show "No results"
          suggestionsElement.innerHTML = uiTexts[currentLang].suggestions; // Keep suggestions visible
          suggestionsElement.style.display = 'block';
          columnsContainer.innerHTML = ''; // Clear columns to only show messages
      } else {
          noResultsMessage.style.display = 'none'; // Hide "No results"
          suggestionsElement.style.display = 'none'; // Hide suggestions if results are shown
      }

      // Scroll to the first result if there's only one column number match
      if (filteredResults.length === 1 && !isNaN(q) && filteredResults[0].column.toString() === q) {
        setTimeout(() => {
          document.getElementById('column-' + q)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
      }
    });

    document.getElementById('dark-mode-toggle').addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const isDarkMode = document.body.classList.contains('dark-mode');
      localStorage.setItem('arbaeenDarkMode', isDarkMode); // Save dark mode preference
    });

    // Apply dark mode preference on load
    if (localStorage.getItem('arbaeenDarkMode') === 'true') {
      document.body.classList.add('dark-mode');
    }

    // NEW JS FOR COLLAPSIBLE INFO SECTION
    document.addEventListener('DOMContentLoaded', () => {
      const infoHeaders = document.querySelectorAll('.info-header');

      infoHeaders.forEach(header => {
        header.addEventListener('click', () => {
          const content = header.nextElementSibling; // Get the content div
          const arrow = header.querySelector('.arrow');

          // Toggle 'expanded' class on the header
          header.classList.toggle('expanded');

          // Expand or collapse content
          if (content.style.maxHeight) {
            content.style.maxHeight = null; // Collapse
            content.style.padding = '0 20px'; // Remove padding when collapsed
          } else {
            content.style.maxHeight = content.scrollHeight + 'px'; // Expand to full height
            content.style.padding = '15px 20px'; // Restore padding when expanded
          }
        });
      });
    });

    // Initialize UI and data
    switchLanguage(currentLang); // Set initial language and load data based on saved preference
    setInterval(updateCountdown, 1000);
    updateCountdown(); // Call once immediately to avoid delay
  </script>
</body>
</html>
